<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÂõöÂæíÂÅ•Ë∫´ (Pro)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- v2.0 ÊöóÈªëÂ∑•‰∏öÈ£é‰∏ªÈ¢ò --- */
        :root {
            --bg: #121212;          /* Ê∑±ÈÇÉËÉåÊôØ */
            --card-bg: #1e1e1e;     /* Âç°ÁâáËÉåÊôØ */
            --text-main: #e0e0e0;   /* ‰∏ªË¶ÅÊñáÂ≠ó */
            --text-sub: #a0a0a0;    /* Ê¨°Ë¶ÅÊñáÂ≠ó */
            --border: #333333;      /* ËæπÊ°ÜÁ∫ø */
            
            /* Âä®‰Ωú‰∏ìÂ±ûËâ≤ (NeonÁâà) */
            --color-pushup: #ff5252;
            --color-squat: #448aff;
            --color-pullup: #ffd740;
            --color-legraise: #69f0ae;
            --color-bridge: #e040fb;
            --color-handstand: #607d8b;
            
            --success: #00c853;
            --danger: #ff5252;
        }

        body {
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text-main);
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
        }

        .container { max-width: 600px; margin: 0 auto; padding: 20px; padding-bottom: 90px; }
        
        h1 { font-size: 24px; letter-spacing: 1px; text-transform: uppercase; margin-bottom: 30px; font-weight: 800; }
        h2 { border-left: 4px solid #fff; padding-left: 10px; font-size: 18px; margin-bottom: 20px; }
        h3 { color: var(--text-sub); font-size: 14px; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        /* --- Ê†∏ÂøÉÂç°ÁâáÊ†∑Âºè --- */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }

        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 140px; 
        }

        .card:active { transform: scale(0.96); background: #2c2c2c; }
        .card.active-glow { box-shadow: 0 0 15px rgba(255, 255, 255, 0.05); border-color: rgba(255,255,255,0.2); }

        .card-icon {
            width: 32px; height: 32px;
            opacity: 0.8;
            margin-bottom: 10px;
        }
        .card-icon svg { width: 100%; height: 100%; fill: currentColor; }

        .card-title { font-size: 16px; font-weight: bold; margin: 0; }
        .card-subtitle { font-size: 12px; color: var(--text-sub); margin-top: 5px; }

        .progress-track {
            width: 100%; height: 4px; background: #333; border-radius: 2px; margin-top: auto; position: relative;
        }
        .progress-fill { height: 100%; border-radius: 2px; transition: width 0.5s ease; }

        button {
            width: 100%; padding: 16px; background-color: #333; color: #fff; border: none; border-radius: 12px;
            font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; transition: background 0.2s;
        }
        button:active { background-color: #555; }
        button.primary { background: linear-gradient(135deg, #444, #222); border: 1px solid #555; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        button.save-btn { background: var(--success); color: #000; }
        button.secondary { background: transparent; border: 1px solid #444; color: var(--text-sub); }
        
        input, select {
            width: 100%; padding: 15px; background: #2c2c2c; border: 1px solid #444; color: #fff;
            border-radius: 12px; box-sizing: border-box; font-size: 16px; outline: none;
        }
        input:focus { border-color: #888; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: var(--text-sub); font-size: 12px; text-transform: uppercase; }

        #toast {
            visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center;
            border-radius: 50px; padding: 16px; position: fixed; z-index: 1000; left: 50%; top: 30px;
            transform: translateX(-50%); box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-size: 14px; opacity: 0;
            transition: opacity 0.3s, top 0.3s; border: 1px solid #555; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        #toast.show { visibility: visible; opacity: 1; top: 50px; }

        .goal-box {
            background: rgba(255,255,255,0.05); border-left: 4px solid var(--text-sub); padding: 15px;
            border-radius: 8px; margin-bottom: 20px; font-size: 14px; color: var(--text-main);
        }
        .log-item {
            background: var(--card-bg); padding: 15px; margin-bottom: 10px; border-radius: 12px;
            display: flex; justify-content: space-between; align-items: center; border: 1px solid #333;
        }
        .log-date { color: var(--text-sub); font-size: 12px; }
        .delete-btn { background: transparent; color: var(--danger); border: 1px solid var(--danger); padding: 6px 12px; font-size: 12px; width: auto; margin: 0;}

        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 999; display: none; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .detail-view { display: none; animation: fadeIn 0.3s; }
        .show { display: block; }
        .hide { display: none; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .chart-container { position: relative; height: 300px; width: 100%; margin-top: 20px; }
        .chart-legend { display: flex; justify-content: center; gap: 20px; margin-top: 15px; font-size: 12px; color: var(--text-sub); }
        .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }

    </style>
</head>
<body>

<div id="loading" class="loading-overlay"><div class="spinner"></div></div>
<div id="toast">‚úÖ ‰øùÂ≠òÊàêÂäü</div>

<div class="container">
    
    <div id="dashboard">
        <h1>CONVICT CONDITIONING <span style="font-size:12px; color:#666; vertical-align: middle">PRO</span></h1>
        
        <div class="grid" id="menu-grid"></div>

        <div style="margin-top:30px; display: flex; gap: 15px;">
            <button class="primary" style="flex:1" onclick="openStatsPage()">üìä ÁîüÊ∂ØÁªüËÆ°</button>
            <button class="primary" style="flex:1; border-color: var(--color-bridge)" onclick="openRadarPage()">üåü ËÉΩÂäõÈõ∑Ëææ</button>
        </div>
        
        <button class="secondary" style="margin-top:15px; border-style:dashed; display:none" onclick="uploadLocalData()" id="upload-btn">‚¨ÜÔ∏è ÂêåÊ≠•Êú¨Âú∞ÊóßÊï∞ÊçÆ</button>

        <div style="margin-top:40px;">
            <h3>Latest Logs</h3>
            <div id="recent-logs">Syncing...</div>
        </div>
    </div>

    <div id="workout-page" class="detail-view">
        <h2 id="page-title">WORKOUT</h2>
        <div class="form-group">
            <label>LEVEL SELECT</label>
            <select id="step-select" onchange="updateGoalDisplay()"></select>
        </div>
        <div id="goal-box" class="goal-box">
            <span style="color:var(--text-sub); font-size:12px; font-weight:bold; display:block; margin-bottom:5px;">TARGET</span>
            <span id="goal-text">Loading...</span>
        </div>
        <div class="form-group">
            <label>REPS (e.g., 20 20 15)</label>
            <input type="tel" id="reps-input" placeholder="Enter reps...">
        </div>
        <div class="form-group">
            <label>NOTES</label>
            <input type="text" id="note-input" placeholder="Form check, pain, etc.">
        </div>
        <button class="save-btn" onclick="saveLog()">COMPLETE WORKOUT</button>
        <button class="secondary" onclick="goHome()">CANCEL</button>
    </div>

    <div id="stats-page" class="detail-view">
        <h2>CAREER STATS</h2>
        <div class="grid" id="stats-grid"></div>
        <button class="secondary" onclick="goHome()">BACK</button>
    </div>

    <div id="radar-page" class="detail-view">
        <h2>SKILL RADAR</h2>
        <div class="chart-container">
            <canvas id="skillChart"></canvas>
        </div>
        <div class="chart-legend">
            <div><span class="dot" style="background:rgba(255,255,255,0.8)"></span>Active</div>
            <div><span class="dot" style="background:#555"></span>Inactive (>14 days)</div>
        </div>
        <button class="secondary" style="margin-top:30px" onclick="goHome()">BACK</button>
    </div>

</div>

<script>
    // ----------------------------------------------------
    const SUPABASE_URL = 'https://pcqnommlfizdqeyodsfw.supabase.co'; 
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBjcW5vbW1sZml6ZHFleW9kc2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjczNjUyMTIsImV4cCI6MjA4Mjk0MTIxMn0.i_xy37yDL8-D7mnDkQmJfzjK2EQgXQCLLvDN8BImotg'; 
    // ----------------------------------------------------

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // üé® ‰øÆÂ§çÁÇπÔºöname ÂøÖÈ°ªÊîπÂõû‰∏≠Êñá "‰øØÂçßÊíë" ‰ª•ÂåπÈÖçÊï∞ÊçÆÂ∫ìÊóßÊï∞ÊçÆ
    // üé® Êñ∞Â¢û uiNameÔºöÁî®‰∫éÁïåÈù¢ÊòæÁ§∫Ëã±Êñá "PUSHUP"
    const exercises = {
        pushup: { 
            name: "‰øØÂçßÊíë", uiName: "PUSHUP", color: "var(--color-pushup)", 
            icon: '<path d="M20.5 11H3.5C2.67 11 2 11.67 2 12.5V14H22V12.5C22 11.67 21.33 11 20.5 11M3 6H21V4H3V6M17.5 15H6.5C5.67 15 5 15.67 5 16.5V19H19V16.5C19 15.67 18.33 15 17.5 15Z" />' 
        },
        squat: { 
            name: "Ê∑±Ëπ≤", uiName: "SQUAT", color: "var(--color-squat)",
            icon: '<path d="M16,13C15.71,13 15.38,13 15.03,13.05C16.19,13.89 17,15 17,16.5V21H7V16.5C7,14.89 7.9,13.66 9.27,13.03C8.75,13 8.29,13 8,13C4.14,13 1,16.14 1,20V22H23V20C23,16.14 19.86,13 16,13M12,2C14.21,2 16,3.79 16,6C16,8.21 14.21,10 12,10C9.79,10 8,8.21 8,6C8,3.79 9.79,2 12,2Z" />'
        },
        pullup: { 
            name: "Âºï‰ΩìÂêë‰∏ä", uiName: "PULLUP", color: "var(--color-pullup)",
            icon: '<path d="M5,3H19C20.1,3 21,3.9 21,5V7H19V5H5V7H3V5C3,3.9 3.9,3 5,3M12,8C10.9,8 10,8.9 10,10S10.9,12 12,12S14,11.1 14,10S13.1,8 12,8M12,14C10,14 6,15 6,17V21H18V17C18,15 14,14 12,14Z" />'
        },
        legraise: { 
            name: "‰∏æËÖø", uiName: "LEG RAISE", color: "var(--color-legraise)",
            icon: '<path d="M22 2H2V4H22V2M19 13L16 22H14L17 13H13L10 22H8L12 10H6L4 16H2L5 7H16L19 13Z" />'
        },
        bridge: { 
            name: "Ê°•", uiName: "BRIDGE", color: "var(--color-bridge)",
            icon: '<path d="M2,16H5L7,11H17L19,16H22V18H18L17,14H7L6,18H2V16M12,8A3,3 0 0,0 9,11A3,3 0 0,0 12,14A3,3 0 0,0 15,11A3,3 0 0,0 12,8Z" />'
        },
        handstand: { 
            name: "ÂÄíÁ´ãÊíë", uiName: "HANDSTAND", color: "var(--color-handstand)",
            icon: '<path d="M21,12H19V17H17L12,5L7,17H5V12H3V22H5V19H7V22H17V19H19V22H21V12M12,4A2,2 0 0,0 10,2A2,2 0 0,0 12,0A2,2 0 0,0 14,2A2,2 0 0,0 12,4Z" />'
        }
    };

    const stepNames = {
        pushup: ["Â¢ôÂ£Å‰øØÂçßÊíë", "‰∏äÊñú‰øØÂçßÊíë", "ËÜùÁõñ‰øØÂçßÊíë", "ÂçäÁ®ã‰øØÂçßÊíë", "Ê†áÂáÜ‰øØÂçßÊíë", "Á™ÑË∑ù‰øØÂçßÊíë", "ÂÅèÈáç‰øØÂçßÊíë", "ÂçïËáÇÂçäÁ®ã‰øØÂçßÊíë", "Êù†ÊùÜ‰øØÂçßÊíë", "ÂçïËáÇ‰øØÂçßÊíë"],
        squat: ["ËÇ©ÂÄíÁ´ãÊ∑±Ëπ≤", "ÊäòÂàÄÊ∑±Ëπ≤", "ÊîØÊíëÊ∑±Ëπ≤", "ÂçäÁ®ãÊ∑±Ëπ≤", "Ê†áÂáÜÊ∑±Ëπ≤", "Á™ÑË∑ùÊ∑±Ëπ≤", "ÂÅèÈáçÊ∑±Ëπ≤", "ÂçïËÖøÂçäÁ®ãÊ∑±Ëπ≤", "ËæÖÂä©ÂçïËÖøÊ∑±Ëπ≤", "ÂçïËÖøÊ∑±Ëπ≤"],
        pullup: ["ÂûÇÁõ¥Âºï‰Ωì", "Ê∞¥Âπ≥Âºï‰Ωì", "ÊäòÂàÄÂºï‰Ωì", "ÂçäÁ®ãÂºï‰ΩìÂêë‰∏ä", "Ê†áÂáÜÂºï‰ΩìÂêë‰∏ä", "Á™ÑË∑ùÂºï‰ΩìÂêë‰∏ä", "ÂÅèÈáçÂºï‰ΩìÂêë‰∏ä", "ÂçïËáÇÂçäÁ®ãÂºï‰Ωì", "ËæÖÂä©ÂçïËáÇÂºï‰Ωì", "ÂçïËáÇÂºï‰ΩìÂêë‰∏ä"],
        legraise: ["ÂùêÂßøÂ±àËÜù", "Âπ≥ÂçßÊä¨ËÜù", "Âπ≥ÂçßÂ±à‰∏æËÖø", "Âπ≥ÂçßËõô‰∏æËÖø", "Âπ≥ÂçßÁõ¥‰∏æËÖø", "ÊÇ¨ÂûÇÊä¨ËÜù", "ÊÇ¨ÂûÇÂ±à‰∏æËÖø", "ÊÇ¨ÂûÇËõô‰∏æËÖø", "ÊÇ¨ÂûÇÂçäÁ®ãÁõ¥‰∏æËÖø", "ÊÇ¨ÂûÇÁõ¥‰∏æËÖø"],
        bridge: ["Áü≠Ê°•", "Áõ¥Ê°•", "È´ò‰ΩéÊ°•", "È°∂Ê°•", "ÂçäÊ°•", "Ê†áÂáÜÊ°•", "‰∏ãË°åÊ°•", "‰∏äË°åÊ°•", "ÂêàÊ°•", "ÈìÅÊùøÊ°• (Á´ôÁ´ã‰∏ãËÖ∞)"],
        handstand: ["Èù†Â¢ôÈ°∂Á´ã", "‰πåÈ∏¶Âºè", "Èù†Â¢ôÂÄíÁ´ã", "ÂçäÁ®ãÂÄíÁ´ãÊíë", "Ê†áÂáÜÂÄíÁ´ãÊíë", "Á™ÑË∑ùÂÄíÁ´ãÊíë", "ÂÅèÈáçÂÄíÁ´ãÊíë", "ÂçïËáÇÂçäÁ®ãÂÄíÁ´ãÊíë", "Êù†ÊùÜÂÄíÁ´ãÊíë", "ÂçïËáÇÂÄíÁ´ãÊíë"]
    };

    const standards = {
        pushup: { 1: "3ÁªÑÔºåÊØèÁªÑ50Ê¨°", 2: "3ÁªÑÔºåÊØèÁªÑ40Ê¨°", 3: "3ÁªÑÔºåÊØèÁªÑ30Ê¨°", 4: "2ÁªÑÔºåÊØèÁªÑ25Ê¨°", 5: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 6: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 7: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 8: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 9: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 10: "1ÁªÑÔºå100Ê¨° (ÂçïËáÇ)" },
        squat: { 1: "3ÁªÑÔºåÊØèÁªÑ50Ê¨°", 2: "3ÁªÑÔºåÊØèÁªÑ40Ê¨°", 3: "3ÁªÑÔºåÊØèÁªÑ30Ê¨°", 4: "2ÁªÑÔºåÊØèÁªÑ50Ê¨°", 5: "2ÁªÑÔºåÊØèÁªÑ30Ê¨°", 6: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 7: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 8: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 9: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 10: "2ÁªÑÔºåÊØèÁªÑ50Ê¨° (ÂçïËÖø)" },
        pullup: { 1: "3ÁªÑÔºåÊØèÁªÑ40Ê¨°", 2: "3ÁªÑÔºåÊØèÁªÑ30Ê¨°", 3: "3ÁªÑÔºåÊØèÁªÑ20Ê¨°", 4: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 5: "2ÁªÑÔºåÊØèÁªÑ10Ê¨°", 6: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 7: "2ÁªÑÔºåÊØèÁªÑ9Ê¨°", 8: "2ÁªÑÔºåÊØèÁªÑ8Ê¨°", 9: "2ÁªÑÔºåÊØèÁªÑ7Ê¨°", 10: "2ÁªÑÔºåÊØèÁªÑ6Ê¨° (ÂçïËáÇ)" },
        legraise: { 1: "3ÁªÑÔºåÊØèÁªÑ40Ê¨°", 2: "3ÁªÑÔºåÊØèÁªÑ40Ê¨°", 3: "3ÁªÑÔºåÊØèÁªÑ40Ê¨°", 4: "3ÁªÑÔºåÊØèÁªÑ25Ê¨°", 5: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 6: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 7: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 8: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 9: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 10: "2ÁªÑÔºåÊØèÁªÑ30Ê¨° (ÊÇ¨ÂûÇÁõ¥ËÖø)" },
        bridge: { 1: "3ÁªÑÔºåÊØèÁªÑ50Ê¨°", 2: "3ÁªÑÔºåÊØèÁªÑ40Ê¨°", 3: "3ÁªÑÔºåÊØèÁªÑ30Ê¨°", 4: "2ÁªÑÔºåÊØèÁªÑ25Ê¨°", 5: "2ÁªÑÔºåÊØèÁªÑ20Ê¨°", 6: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 7: "2ÁªÑÔºåÊØèÁªÑ10Ê¨°", 8: "2ÁªÑÔºåÊØèÁªÑ8Ê¨°", 9: "2ÁªÑÔºåÊØèÁªÑ6Ê¨°", 10: "2ÁªÑÔºåÊØèÁªÑ50Ê¨° (ÈìÅÊùøÊ°•)" },
        handstand: { 1: "2ÂàÜÈíü (ÂÄíÁ´ã)", 2: "1ÂàÜÈíü (‰πåÈ∏¶Âºè)", 3: "2ÂàÜÈíü (Èù†Â¢ôÂÄíÁ´ã)", 4: "2ÁªÑÔºåÊØèÁªÑ20Ê¨° (ÂçäÁ®ã)", 5: "2ÁªÑÔºåÊØèÁªÑ15Ê¨°", 6: "2ÁªÑÔºåÊØèÁªÑ10Ê¨°", 7: "2ÁªÑÔºåÊØèÁªÑ8Ê¨°", 8: "2ÁªÑÔºåÊØèÁªÑ6Ê¨°", 9: "2ÁªÑÔºåÊØèÁªÑ4Ê¨°", 10: "1ÁªÑÔºå5Ê¨° (ÂçïËáÇ)" }
    };

    let currentExerciseKey = '';
    let globalLogs = []; 
    let maxProgress = { pushup: 1, squat: 1, pullup: 1, legraise: 1, bridge: 1, handstand: 1 };
    let myRadarChart = null;

    async function init() {
        const localLogs = JSON.parse(localStorage.getItem('training_logs') || "[]");
        if (localLogs.length > 0) {
            document.getElementById('upload-btn').style.display = 'block';
        }
        await fetchLogs(); 
    }

    // üé® Ê∏≤ÊüìÈ¶ñÈ°µÔºö‰ΩøÁî® uiName (Ëã±Êñá) ÊòæÁ§∫Ôºå‰ΩÜÊï∞ÊçÆÂåπÈÖçÁî® name (‰∏≠Êñá)
    function renderDashboardGrid() {
        const grid = document.getElementById('menu-grid');
        grid.innerHTML = '';
        
        for (let key in exercises) {
            let item = exercises[key];
            let maxStep = maxProgress[key]; 
            let currentName = stepNames[key][maxStep - 1];
            
            let progressPercent = (maxStep / 10) * 100;

            const lastLog = globalLogs.find(log => log.exercise === item.name); // ‰øÆÂ§çÔºöÁî®‰∏≠ÊñáÂêçÂéªÂåπÈÖç
            let isActive = false;
            if (lastLog) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(lastLog.created_at)) / (86400000));
                if (diffDays <= 14) isActive = true;
            }

            let glowClass = isActive ? 'active-glow' : '';
            let borderColor = isActive ? item.color : 'transparent';
            
            grid.innerHTML += `
                <div class="card ${glowClass}" style="border-color:${borderColor}" onclick="openExercise('${key}')">
                    <div style="display:flex; justify-content:space-between; align-items:start">
                        <div class="card-icon" style="color:${item.color}">
                            <svg viewBox="0 0 24 24">${item.icon}</svg>
                        </div>
                        <span style="font-size:24px; font-weight:bold; color:#fff">${maxStep}</span>
                    </div>
                    <div>
                        <h3 class="card-title" style="color:${item.color}">${item.uiName}</h3> <p class="card-subtitle">${currentName}</p>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill" style="width:${progressPercent}%; background:${item.color}"></div>
                    </div>
                </div>
            `;
        }
    }

    async function fetchLogs() {
        document.getElementById('recent-logs').innerHTML = '<span style="color:#666">Connecting to cloud...</span>';
        const { data, error } = await supabaseClient.from('logs').select('*').order('created_at', { ascending: false });
        if (error) { console.error(error); document.getElementById('recent-logs').innerHTML = '<span style="color:var(--danger)">Sync Failed</span>'; return; }
        
        globalLogs = data; 
        
        // ËÆ°ÁÆóÊúÄÈ´òÁ≠âÁ∫ßÔºà‰øÆÂ§çÔºöÁî®‰∏≠ÊñáÂêçÂåπÈÖçÔºâ
        maxProgress = { pushup: 1, squat: 1, pullup: 1, legraise: 1, bridge: 1, handstand: 1 };
        globalLogs.forEach(log => {
            // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöËøôÈáåÁöÑ k.name ÂøÖÈ°ªÊòØ‰∏≠Êñá "‰øØÂçßÊíë"ÔºåÊâçËÉΩÂåπÈÖçÂà∞ log.exercise
            let key = Object.keys(exercises).find(k => exercises[k].name === log.exercise);
            if (key && log.step > maxProgress[key]) {
                maxProgress[key] = log.step;
            }
        });

        renderHistory(globalLogs);
        renderDashboardGrid(); 
    }

    function openExercise(key) {
        currentExerciseKey = key;
        showPage('workout-page');
        document.getElementById('page-title').innerText = exercises[key].uiName; // ÁïåÈù¢ÊòæÁ§∫Ëã±Êñá
        document.getElementById('page-title').style.color = exercises[key].color;
        
        const selectEl = document.getElementById('step-select');
        selectEl.innerHTML = ''; 
        stepNames[key].forEach((name, index) => {
            let stepNum = index + 1;
            let option = document.createElement('option');
            option.value = stepNum;
            option.text = `${stepNum}. ${name}`;
            selectEl.appendChild(option);
        });
        
        let savedStep = localStorage.getItem(`step_${key}`) || 1;
        selectEl.value = savedStep;
        updateGoalDisplay();
        document.getElementById('reps-input').value = '';
        document.getElementById('note-input').value = '';
    }

    function openRadarPage() {
        showPage('radar-page');
        const dataValues = [];
        const labels = [];
        const pointColors = []; 
        const order = ['pushup', 'squat', 'pullup', 'legraise', 'bridge', 'handstand'];

        order.forEach(key => {
            dataValues.push(maxProgress[key]);
            labels.push(exercises[key].uiName); // Èõ∑ËææÂõæÊ†áÁ≠æÁî®Ëã±Êñá

            // Ê¥ªË∑ÉÂà§Êñ≠Ôºà‰øÆÂ§çÔºöÁî®‰∏≠ÊñáÂêçÂåπÈÖçÔºâ
            const lastLog = globalLogs.find(log => log.exercise === exercises[key].name);
            let isDecayed = true; 
            if (lastLog) {
                const diffDays = Math.ceil(Math.abs(new Date() - new Date(lastLog.created_at)) / (86400000));
                if (diffDays <= 14) isDecayed = false;
            }
            pointColors.push(isDecayed ? '#555' : '#fff');
        });

        if (myRadarChart) { myRadarChart.destroy(); }

        const ctx = document.getElementById('skillChart').getContext('2d');
        Chart.defaults.color = '#888';
        Chart.defaults.scale.grid.color = '#333';
        
        myRadarChart = new Chart(ctx, {
            type: 'radar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Capability',
                    data: dataValues,
                    backgroundColor: 'rgba(255, 255, 255, 0.1)',
                    borderColor: '#fff',
                    borderWidth: 2,
                    pointBackgroundColor: pointColors, 
                    pointBorderColor: pointColors,
                    pointRadius: 6
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { color: '#333' },
                        grid: { color: '#333' },
                        suggestedMin: 0,
                        suggestedMax: 10,
                        ticks: { display: false, stepSize: 2 },
                        pointLabels: { font: { size: 12, weight: 'bold' }, color: '#fff' }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.className = 'show';
        if (navigator.vibrate) navigator.vibrate(50);
        setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 3000);
    }

    async function saveLog() {
        const step = document.getElementById('step-select').value;
        let rawReps = document.getElementById('reps-input').value;
        const note = document.getElementById('note-input').value;

        if (!rawReps) { alert("Please enter reps"); return; }
        const reps = rawReps.replace(/Ôºå|\s+/g, ','); 

        localStorage.setItem(`step_${currentExerciseKey}`, step);
        showLoading(true);

        // ‰øÆÂ§çÔºö‰øùÂ≠òÊó∂‰æùÁÑ∂Áî®‰∏≠ÊñáÂêçÔºåÁ°Æ‰øùÊï∞ÊçÆÂ∫ìÁ∫ØÂáÄ
        const { error } = await supabaseClient.from('logs').insert({
                exercise: exercises[currentExerciseKey].name,
                step: parseInt(step),
                reps: reps,
                note: note
            });
        
        if (error) { 
            showLoading(false);
            alert('Error: ' + error.message); 
        } else { 
            await fetchLogs(); 
            showLoading(false);
            showToast("‚úÖ WORKOUT SAVED"); 
            goHome(); 
        }
    }

    async function deleteLog(id) {
        if (!confirm("Delete this log?")) return;
        showLoading(true);
        const { error } = await supabaseClient.from('logs').delete().eq('id', id);
        showLoading(false);
        if (error) { alert('Error: ' + error.message); } 
        else { await fetchLogs(); showToast("üóëÔ∏è LOG DELETED"); }
    }

    async function uploadLocalData() {
        const localLogs = JSON.parse(localStorage.getItem('training_logs') || "[]");
        if (!confirm(`Upload ${localLogs.length} old logs?`)) return;
        showLoading(true);
        const payload = localLogs.map(log => ({
            exercise: log.exerciseName, step: parseInt(log.step), reps: log.reps, note: log.note, created_at: new Date(log.id).toISOString() 
        }));
        const { error } = await supabaseClient.from('logs').insert(payload);
        showLoading(false);
        if (error) { alert("Error: " + error.message); } 
        else { 
            showToast("üéâ UPLOAD SUCCESS");
            localStorage.removeItem('training_logs'); 
            document.getElementById('upload-btn').style.display = 'none';
            await fetchLogs(); 
        }
    }

    function renderHistory(logs) {
        const container = document.getElementById('recent-logs');
        if (logs.length === 0) { container.innerHTML = '<p style="text-align:center;color:#444">NO DATA</p>'; return; }
        container.innerHTML = logs.slice(0, 10).map(log => {
            const dateObj = new Date(log.created_at);
            // ÁïåÈù¢ÁæéÂåñÔºöÂ∞ùËØïÊää‰∏≠ÊñáÂêçËΩ¨ÊàêËã±ÊñáÂêçÊòæÁ§∫ÔºåÊâæ‰∏çÂà∞Â∞±ÊòæÁ§∫ÂéüÂêç
            let displayTitle = log.exercise;
            let conf = Object.values(exercises).find(e => e.name === log.exercise);
            if (conf) displayTitle = conf.uiName;

            return `
            <div class="log-item">
                <div class="log-content">
                    <strong style="color:#fff">${displayTitle}</strong> <span style="font-size:12px;color:#888">(#${log.step})</span><br>
                    <span style="font-size:14px; color:#aaa">Sets: ${log.reps}</span>
                    ${log.note ? `<br><span style="font-size:12px;color:#666">üìù ${log.note}</span>` : ''}
                </div>
                <div class="log-actions">
                    <span class="log-date">${dateObj.toLocaleDateString()}</span>
                    <button class="delete-btn" onclick="deleteLog(${log.id})">DEL</button>
                </div>
            </div>`;
        }).join('');
    }

    function openStatsPage() {
        showPage('stats-page');
        const statsGrid = document.getElementById('stats-grid');
        statsGrid.innerHTML = ''; 
        let totals = {};
        for (let key in exercises) { totals[exercises[key].name] = { reps: 0, sets: 0, color: exercises[key].color, uiName: exercises[key].uiName }; }
        
        globalLogs.forEach(log => {
            // ‰øÆÂ§çÔºöÁî®‰∏≠ÊñáÂêç log.exercise Âéª totals Â≠óÂÖ∏ÈáåÊü•
            if (totals[log.exercise]) {
                let parts = log.reps.split(',');
                totals[log.exercise].sets += parts.length;
                parts.forEach(num => totals[log.exercise].reps += (parseInt(num) || 0));
            }
        });
        for (let name in totals) {
            let data = totals[name];
            statsGrid.innerHTML += `
                <div class="card" style="height:auto; border-top:4px solid ${data.color}">
                    <h3 style="margin:0; color:#fff">${data.uiName}</h3> <span style="font-size:28px; font-weight:bold; color:${data.color}; display:block; margin:10px 0">${data.reps}</span>
                    <span style="font-size:12px; color:#666">TOTAL REPS (${data.sets} SETS)</span>
                </div>
            `;
        }
    }

    function updateGoalDisplay() {
        const step = document.getElementById('step-select').value;
        const standardText = standards[currentExerciseKey][step];
        document.getElementById('goal-text').innerText = standardText || "N/A";
        document.getElementById('goal-box').style.borderLeftColor = exercises[currentExerciseKey].color;
    }

    function showPage(pageId) {
        ['dashboard','workout-page','stats-page','radar-page'].forEach(id => {
            document.getElementById(id).classList.remove('show');
            document.getElementById(id).classList.add('hide');
        });
        if(pageId === 'dashboard') {
            document.getElementById('dashboard').classList.remove('hide');
            renderDashboardGrid();
        } else {
            document.getElementById(pageId).classList.remove('hide');
            document.getElementById(pageId).classList.add('show');
        }
    }

    function goHome() { showPage('dashboard'); fetchLogs(); }
    function showLoading(isLoading) { document.getElementById('loading').style.display = isLoading ? 'flex' : 'none'; }

    init();
</script>
</body>
</html>